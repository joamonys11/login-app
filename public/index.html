<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MariaDB Login System</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="login-container" id="loginContainer">
    <h2>MariaDB Login</h2>
    <form id="loginForm">
      <input type="text" id="username" placeholder="Username" required><br>
      <input type="password" id="password" placeholder="Password" required><br>
      <button type="submit" id="loginBtn">
        <span id="loginText">Login</span>
        <span id="loading" style="display:none;">Loading...</span>
      </button>
    </form>
    <div id="message"></div>
    <div id="sqlPreview" class="sql-preview" style="display: none;"></div>
  </div>

  <div class="dashboard" id="dashboard" style="display: none;">
    <h2 id="welcomeMessage"></h2>
    <img id="avatarImg" src="" alt="Avatar" width="100"><br>
    <p><strong>Name:</strong> <span id="profileName"></span></p>
    <p><strong>Username:</strong> <span id="profileUsername"></span></p>
    <p><strong>Email:</strong> <span id="profileEmail"></span></p>
    <p><strong>Age:</strong> <span id="profileAge"></span></p>
    <p><strong>Study:</strong> <span id="profileStudy"></span></p>
    <p><strong>Civil Status:</strong> <span id="profileCivil"></span></p>
    <p><strong>Login Count:</strong> <span id="loginCount"></span></p>
    <button onclick="logout()">Logout</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      checkAuthStatus();

      document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const messageDiv = document.getElementById('message');
        const sqlPreview = document.getElementById('sqlPreview');
        const loginBtn = document.getElementById('loginBtn');
        const loginText = document.getElementById('loginText');
        const loading = document.getElementById('loading');

        messageDiv.innerHTML = '';
        sqlPreview.style.display = 'none';

        loginBtn.disabled = true;
        loginText.style.display = 'none';
        loading.style.display = 'inline';

        try {
          const res = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          const data = await res.json();

          if (res.ok && data.success) {
            messageDiv.innerHTML = '<div class="message success">✅ Login successful!</div>';
            sqlPreview.innerHTML = `<strong>SQL Executed:</strong><br>${data.sqlPreview}`;
            sqlPreview.style.display = 'block';
            setTimeout(loadUserProfile, 1000);
          } else {
            messageDiv.innerHTML = `<div class="message error">❌ ${data.error}</div>`;
            if (data.sqlPreview) {
              sqlPreview.innerHTML = `<strong>SQL Executed:</strong><br>${data.sqlPreview}`;
              sqlPreview.style.display = 'block';
            }
          }
        } catch (error) {
          messageDiv.innerHTML = '<div class="message error">❌ Server error occurred.</div>';
        } finally {
          loginBtn.disabled = false;
          loginText.style.display = 'inline';
          loading.style.display = 'none';
        }
      });
    });

    async function checkAuthStatus() {
      const res = await fetch('/api/auth-status');
      const data = await res.json();
      if (data.authenticated) {
        loadUserProfile();
      }
    }

    async function loadUserProfile() {
      const res = await fetch('/api/profile');
      const data = await res.json();
      if (!res.ok || !data.user) return;

      const user = data.user;
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';

      document.getElementById('welcomeMessage').textContent = `Welcome back, ${user.name}!`;
      document.getElementById('avatarImg').src = user.avatar;
      document.getElementById('profileName').textContent = user.name;
      document.getElementById('profileUsername').textContent = user.username;
      document.getElementById('profileEmail').textContent = user.email;
      document.getElementById('profileAge').textContent = `${user.age} years old`;
      document.getElementById('profileStudy').textContent = user.study;
      document.getElementById('profileCivil').textContent = user.civil_status;
      document.getElementById('loginCount').textContent = user.login_count;
    }

    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      document.getElementById('loginForm').reset();
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('loginContainer').style.display = 'block';
      document.getElementById('message').innerHTML = '<div class="message success">✅ You have been logged out.</div>';
    }
  </script>
</body>
</html>
